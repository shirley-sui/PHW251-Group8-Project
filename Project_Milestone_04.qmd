---
title: "Project_Milestone_04"
author: "Ngan Nguyen, Nicole Fernandez, Shirley Sui"
format: html
editor: visual
---

## Project Milestone #4: Visualizations

Submit an Rmd or Qmd and publish an html file on RPubs with the following:

## Final datasets for creation of visualization

```{r load libraries, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)

# Load tidyverse for all data cleaning packages
library(tidyverse)
library(kableExtra)
```

```{r load dataset}
#Load data from project Milestone #3 in Milestone_3_Clean_Data
df_vax <- read_csv('./Milestone_3_Clean_Data/df_ca_vax_clean_subset.csv')
df_flu <- read_csv('./Milestone_3_Clean_Data/df_flu_clean_aggregate.csv')
```

-   Join all datasets together
-   Calculate any remaining data elements needed for analysis
-   Show code used to create joined dataset, but please do not print full data frame output (showing data structure with str() is okay)

```{r Join all datasets together}
# Flu data only has quarters 2022.4 to 2023.2
# Vax data has quarters 2022.1 to 2023.3
# Before joining, filter vax data to only 2022.4 to 2023.2

df_vax <- df_vax %>%
  filter(quarter >= 2022.4 & quarter <= 2023.2)

# perform inner_join - we don't want any data that doesn't have a match in both datasets

df_joined <- inner_join(df_flu, df_vax, by = join_by(age_category, county, quarter)) %>% select(!c(sum_dx_new, sum_severe_new)) %>% drop_na()

# show data structure
str(df_joined)
```
## Visualizations (at least one per group member)

-   One print quality table as requested in scenario
-   One print quality plot or chart as requested in scenario
-   For groups of 3, one additional print quality table or plot of your choice (can support the requested data in the scenario, or answer a different question using the same data sources)

#### Research Question(s)
         
-   Identify if COVID vaccination rates reflect flu vaccination rates in populations and or if more should be done to encourage flu vaccinations 
``` {r covid vax vs flu rate - Shirley}
# COVID vaccination rates vs flu rate (new cases), per quarter, color coded by county
library(plotly)
# Re-format facet labels for quarters
qtr.labs <- c("Q4-2022", "Q1-2023", "Q2-2023")
names(qtr.labs) <- c(2022.4, 2023.1, 2023.2)

vax_flu_byqtr <- df_joined %>%
  group_by(county, quarter) %>%
  mutate(mean_vaccination_rate = mean(mean_vaccination_rate), dx_new_rate = mean(dx_new_rate)) %>%
  ggplot(aes(x = mean_vaccination_rate, y = dx_new_rate, color=county)) +
  geom_point() +
  geom_smooth(method = lm, color = "red") +
  theme_minimal() +
  scale_y_continuous(labels= function(x) round(x*100, digits = 1)) + 
  labs(x = "Mean COVID Vaccination Rate 
  (fully vaccinated / population) ", y = "Mean Flu Rate 
  (new diagnoses / 100 susceptible)", title = "COVID vaccination rate does not significantly reflect flu vaccination rate.", subtitle = "based on quarterly COVID vaccination rate data compared to simulated flu incidence rate data per 
quarter across 57 California counties, from Q4-2022 to Q2-2023") +
  facet_wrap(~quarter, scales = "free", labeller = labeller(quarter = qtr.labs)) + 
  theme(
    legend.position = "none", 
    plot.title.position = "plot",
    plot.title = element_text(face = "bold"), 
    plot.subtitle = element_text(face = "italic"), 
    strip.text.x = element_text(face = "bold"))

ggplotly(vax_flu_byqtr) %>%
  layout(
    title = list(text = paste0('COVID vaccination rate does not significantly reflect flu vaccination rate.', '<br>','<sup>','Across 57 California counties, from Q4-2022 to Q2-2023','</sup>'), yref = 'container', xref = 'paper', yref = 'paper'), 
    annotations = list(text = paste0('<sup>','Based on quarterly COVID vaccination rate data compared to simulated flu incidence rate data per quarter','</sup>'), showarrow = F, xref = 'paper', yref = 'paper', xanchor = 'right', yanchor = 'auto', xshift = 350, yshift = -250),
    margin = list(t = 120, b = 110, l = 100, r = 30)
  )
```

-   Identify where there is any correlation between COVID vaccination rates on flu rates and/or severity.
``` {r Correlation table indicating relationship between COVID vaccination rates on severe flu rate - Kim}

summary(df_joined)

# Create categories based on COVID vaccination rates and severe flu rates
data <- df_joined %>%
  mutate(
    COVID_Vaccination_Rate = ifelse(mean_vaccination_rate <= median(mean_vaccination_rate), "Low Vaccination Rate (Min = 0.14)", "High Vaccination Rate (Max = 1.14)"),
    Severe_Flu_Rate = ifelse(severe_new_rate <= median(severe_new_rate), "Low Severe Flu Rate (Min = 0.00)", "High Severe Flu Rate (Max = 0.43)")
  )

# Calculate the correlation for each combination
correlation_table <- data %>%
  group_by(COVID_Vaccination_Rate, Severe_Flu_Rate) %>%
  summarise(
    Correlation = round(cor(mean_vaccination_rate, severe_new_rate), 2)
  )

# Rename columns
colnames(correlation_table) <- c("COVID Vaccination Rate", "Severe Flu Rate", "Correlation")

# Print the correlation table with kableExtra
correlation_table %>%
  kable(
    format = "html", 
    caption = "Correlation between COVID vaccination rates and severity of flu rate, 2022-2023", align = "c"
  ) %>% 
  kable_styling(
    full_width = FALSE,
    position = "center",
    bootstrap_options = c("striped", "hover"),
    latex_options = "striped"
  ) %>%

  # Print the result
print(correlation_table)
```

-   COVID vaccination versus flu severity by age group
```{r age group vax vs flu severity -Nicole}
# Visualization: One print quality plot or chart as requested in scenario
# Using Both a table & a chart seem appropriate for this specific research question

library(kableExtra)
library(ggplot2)


# Rename joined df
age_group_vax_vs_flu_severity <- df_joined

# Rename df
age_group_vax_vs_flu_severity_table <- age_group_vax_vs_flu_severity

# Create a summary table
summary_table <- age_group_vax_vs_flu_severity_table %>%
  group_by(age_category) %>%
  summarize(mean_vaccination_rate = mean(mean_vaccination_rate),
            mean_flu_severity = mean(severe_new_rate))


# Print the table using kableExtra (Quality table #1)
kable(summary_table, "html") %>%
  kable_styling(full_width = FALSE)





# Scatter Plot (Quality plot #1)

# Create a scatter plot
age_group_vax_vs_flu_severity_plot <- ggplot(age_group_vax_vs_flu_severity_table, aes(x = mean_vaccination_rate, y = severe_new_rate, color = age_category)) +
  geom_point() +
  labs(title = "Relationship between Age Group Vaccination Rate and Flu Severity",
       x = "Mean Vaccination Rate",
       y = "Flu Severity Rate",
       color = "Age Category") +
  theme_minimal()

# Print the plot
print(age_group_vax_vs_flu_severity_plot)





# Scatter plot (Quality plot #2)

ggplot(data = age_group_vax_vs_flu_severity, aes(x = age_category, y = severe_new_rate, color = mean_vaccination_rate)) +
  geom_point(size = 3) +
  labs(title = "Age Group Vaccination vs Flu Severity",
       x = "Age Category",
       y = "Flu Severity Rate",
       color = "Mean Vaccination Rate") +
  scale_color_gradient(low = "yellow", high = "red") +  
  theme_minimal()  





# Scatter plot with facets for each age category (GQuality plot #3)
ggplot(data = age_group_vax_vs_flu_severity, aes(x = severe_new_rate, y = mean_vaccination_rate, color = mean_vaccination_rate)) +
  geom_point(size = 3) +
  labs(title = "Vaccination vs Flu Severity by Age Category",
       x = "Flu Severity Rate",
       y = "Mean Vaccination Rate",
       color = "Mean Vaccination Rate") +
  scale_color_gradient(low = "yellow", high = "red") +  
  facet_wrap(~age_category, scales = "free") +  
  theme_minimal()  





# SWITCH X & Y axis  (Quality plot #4)

# Scatter plot with facets for each age category, switching x and y axes
ggplot(data = age_group_vax_vs_flu_severity, aes(x = mean_vaccination_rate, y = severe_new_rate, color = mean_vaccination_rate)) +
  geom_point(size = 3) +
  labs(title = "Vaccination vs Flu Severity by Age Category",
       x = "Mean Vaccination Rate",
       y = "Flu Severity Rate",
       color = "Mean Vaccination Rate") +
  scale_color_gradient(low = "yellow", high = "red") +  
  facet_wrap(~age_category, scales = "free") +  
  theme_minimal()  

```


INTREPRETATION:

=======
-  Correlation table interpretation: Correlation values per each case provide insights into the relationships between COVID vaccination rates and severe flu cases rates in different scenarios, ranging from weak negative to moderate positive correlations. 

## For each visual, include - Code used to generate visual - Legend (if necessary) - 1-2 sentence interpretation

NOTE: Please make sure the visual can stand-alone, meaning it includes enough information in title, legend, and footnote so that a person who sees only the visualization could understand what is being presented. Please also make sure column names, axis labels, and any other labels are meaningful and not just the name of the variable (ex: "County" rather than "county_name")




## Html file that is professionally prepared for presentation and published to RPubs

-   Only the necessary information is in the output (e.g., suppress entire data frame outputs but showing data structure with str() is okay.
-   Code used to import and clean data (milestones 2 and 3) can be included in the rmd/qmd but please use the option include=FALSE in order to prevent the code and any output from. Code chunk would look like {r chunk_name, include=FALSE}
-   Utilize warning=FALSE and message=FALSE to suppress any warnings/messages that may be displaying from any chunks
-   For this milestone please make sure code for visualizations are included in the final file. - Show your work by "echoing" code used in Rmd/Qmd file to create your tables and graphs. \`\`\`{r, echo = TRUE} in code chunk preferences.
-   Use headers and sub headers to create an organized document \## Running Code
