---
title: "Final Project: Exploring the Relationship Between COVID Vaccination and Flu Rates in 57 California Counties, from Q4-2022 to Q2-2023"
author: "Ngan Nguyen, Nicole Fernandez, Shirley Sui"
format: html
editor: visual
---

```{r load & set up, include=FALSE, echo=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)

# Load tidyverse for all data cleaning packages
library(tidyverse)
library(kableExtra)
library(ggplot2)
library(plotly)
library(DT)

#Load data from project Milestone #3 in Milestone_3_Clean_Data
df_vax <- read_csv('./Milestone_3_Clean_Data/df_ca_vax_clean_subset.csv')
df_flu <- read_csv('./Milestone_3_Clean_Data/df_flu_clean_aggregate.csv')

# Join all datasets together
# Flu data only has quarters 2022.4 to 2023.2
# Vax data has quarters 2022.1 to 2023.3
# Before joining, filter vax data to only 2022.4 to 2023.2

df_vax <- df_vax %>%
  filter(quarter >= 2022.4 & quarter <= 2023.2)

# perform inner_join - we don't want any data that doesn't have a match in both datasets
# also rename mean_vaccination_rate to pct_vaccinated

df_joined <- inner_join(df_flu, df_vax, by = join_by(age_category, county, quarter)) %>% select(!c(sum_dx_new, sum_severe_new)) %>% rename(pct_vaccinated = mean_vaccination_rate) %>% drop_na()
```

## [Problem Statement]{.underline}

There is a growing interest in understanding the potential impact of COVID-19 vaccinations on existing respiratory illnesses like the seasonal flu. Understanding whether or where correlation exists between COVID-19 vaccination and flu incidence and severity can help inform the use of public health flu prevention resources. In this project, we explore the relationship between COVID-19 vaccination and flu incidence rate and severity rate over time, geography, and age group using COVID vaccination data and simulated flu data obtained from the California Department of Public Health (CDPH) to address three main questions:

1.  Do COVID vaccination rates reflect flu vaccination rates?
2.  Is there any correlation between COVID vaccination rates and flu severity?
3.  Does COVID vaccination affect flu severity within each age group?

## [Methods]{.underline}

***Data Considerations***

Data collection was organized into quarters. Specifically, quarter 4 (Q4) spans October to December, quarter 1 (Q1) encompasses January to March, and quarter 2 (Q2) covers April to June. The quarterly breakdown captures the peak flu activity typically observed during the colder months. Q4-Q2 (October through June of the following year) are of particular interest, as they encapsulate the period when influenza transmission is historically elevated. This is also likely why the simulated flu data only contained data for Q4-Q2.

***Data Cleaning***

Simulated flu data was obtained from the CDPH in two parts: one dataset with all counties besides Los Angeles County and one dataset with LA County data alone. Both datasets were examined prior to data cleaning, which included renaming columns to match between the datasets, converting columns to date or factor as appropriate, adding a county column to the LA County dataset (so it could be joined to the main California dataset), and recoding race and ethnicity data in the California dataset. Since the California data codebook contained a warning not to use dt_diagnosis in data analysis, the LA County data did not have dt_report values, and converting dt_dx in the LA County data to dt_report was inefficient, we converted dt_report from the California dataset and dt_dx from the LA County dataset to quarters. The LA County data was added to the California dataset using bind_rows, after which the data was grouped by age_category, county, and quarter to summarize the per-strata variables by summing dx_new and severe_new, which we used to calculate new diagnosis rates (sum of new cases / susceptible population) and flu severity rate (sum of new severe cases / sum of new cases).

COVID vaccination data obtained from CDPH was cleaned thoroughly to match the morbidity datasets. This involved deleting duplicate values, renaming columns and values to match with the simulated flu datasets, pivot_wider on the demographic_category column to split each demographic type into a separate column, and reclassifying the age column (specifically, combining "under 5", "5-11", and "12-17" into one category of "0-17") to match the flu data. A percent vaccinated variable was created and defined as cumulative fully vaccinated / estimated population; this variable was then used to calculate mean vaccination rate per strata after the data was grouped by age_category, county, and quarter.

The COVID vaccination data was filtered to Q4 2022 to Q2 2023, as the flu data only contained data for these quarters. Then, flu data and COVID vaccination data were joined using inner_join by age_category, county, and quarter, after which NA values and the sum_dx_new and sum_severe_new columns were dropped. This final dataset was used to create **Tables 1-2** and **Figures 1-2**.

***Do COVID vaccination rates reflect flu vaccination rates?***

**Figure 1** was created by grouping the data by county and quarter to calculate a mean % vaccinated and mean flu incidence rate, which was then plotted against each other, with COVID vaccination as the independent variable, on a scatter plot with a best-fit line.

***Is there any correlation between COVID vaccination rates and flu severity?***

To create **Table 1**, the data was grouped by county to calculate mean values for % COVID-19 vaccination achieved and the severe flu rate of each county. These values were then used to calculate the correlation between COVID vaccination and flu severity in each county.

***Does COVID vaccination affect flu severity within each age group?***

**Table 2** was created similarly; data was grouped by age_category, the stratum of interest for this question, and mean % COVID-19 vaccination and mean severe flu rate were calculated for each age category. Then, these values were used to calculate the correlation between COVID vaccination and flu severity within each age category.

**Figure 2** was also created by plotting mean flu severity rate against mean % vaccinated for COVID (independent variable) in a scatter plot faceted by age category. A best fit line was added to each facet to better assess the presence or absence of an association between the two variables.

## [Results]{.underline}

```{r covid vax vs flu rate - Shirley, warning = FALSE, message = FALSE, echo = FALSE}
# COVID vaccination vs flu rate (new cases), per quarter, color coded by county

# Re-format facet labels for quarters
qtr.labs <- c("Q4-2022", "Q1-2023", "Q2-2023")
names(qtr.labs) <- c(2022.4, 2023.1, 2023.2)

vax_flu_byqtr <- df_joined %>%
  group_by(county, quarter) %>%
  mutate(mean_pct_vaccinated = mean(pct_vaccinated), dx_new_rate = mean(dx_new_rate)) %>%
  ggplot(aes(x = pct_vaccinated, y = dx_new_rate, color=county, text = paste("<b>County: </b>", county, "<br><b>Mean % Vaccinated for COVID: </b>", round(pct_vaccinated, 3)*100,"%", "<br><b>Mean Flu Rate: </b>", round(dx_new_rate,2)))) +
  geom_point() +
  geom_smooth(aes(x = pct_vaccinated, y = dx_new_rate), method = lm, color = "red", inherit.aes = FALSE) +
  theme_minimal() +
  scale_y_continuous(labels= function(x) round(x*100, digits = 2)) + 
  labs(x = "Mean % Vaccinated for COVID 
  (cum. fully vaccinated / population) ", y = "Mean Flu Rate 
  (new diagnoses / 100 susceptible)", title = "Figure 1: COVID vaccination does not imply flu vaccination", subtitle = "based on quarterly cumulative COVID vaccination data compared to simulated flu incidence rate data per 
quarter across 57 California counties, from Q4-2022 to Q2-2023") +
  facet_wrap(~quarter, scales = "free", labeller = labeller(quarter = qtr.labs)) + 
  theme(
    legend.position = "none", 
    plot.title.position = "plot",
    plot.title = element_text(face = "bold"), 
    plot.subtitle = element_text(face = "italic"), 
    strip.text.x = element_text(face = "bold"),
    axis.title.y = element_text(margin = margin(r = 5)),
    axis.title.x = element_text(margin = margin(t = 5)))

ggplotly(vax_flu_byqtr, tooltip = "text") %>%
  layout(
    title = list(text = paste0('Figure 1: COVID vaccination does not imply flu vaccination','<br>','<sup>','Across 57 California counties, from Q4-2022 to Q2-2023','</sup>'), yref = 'container', xref = 'paper', yref = 'paper'), 
    annotations = list(text = paste0('<sup>','Based on quarterly cumulative COVID vaccination data compared to simulated flu incidence rate data per quarter','</sup>'), showarrow = F, xref = 'paper', yref = 'paper', xanchor = 'right', yanchor = 'auto', xshift = 350, yshift = -200),
    margin = list(t = 150, b = 110, l = 100, r = 30)
  )

```

```{r Correlation table indicating relationship between COVID vaccination and severe flu rate - Kim, warning = FALSE, message = FALSE, echo = FALSE}

# Redone - misread research question #2 in previous milestone

# Calculate the correlation for each county
correlation_table <- df_joined %>%
  group_by(county) %>%
  summarise(
    mean_pct_vaccinated_county = mean(pct_vaccinated),
    mean_severe_new_rate = mean(severe_new_rate),
    Correlation = round(cor(pct_vaccinated, severe_new_rate), 2)
  ) %>% 
  ungroup() %>%
  distinct(county, .keep_all = TRUE)

# Rename columns
colnames(correlation_table) <- c("County", "Mean % Vaccinated for COVID", "Mean Severe Flu Rate", "Correlation")

# Print the correlation table with DT
  datatable(
    correlation_table,
    rownames = FALSE,
    caption = htmltools::tags$caption(style = 'text-align: center; font-weight:bold; font-size:16','Table 1: No clear correlation between COVID vaccination and mean severe flu rate within each county, Q4-2022 - Q2-2023'))

```

```{r age group vax vs flu severity -Nicole, warning = FALSE, message = FALSE, echo = FALSE}
# Visualization: One print quality plot or chart as requested in scenario
# Using Both a table & a chart seem appropriate for this specific research question
# Rename joined df
age_group_vax_vs_flu_severity <- df_joined

# Quality plot

# Scatter plot with facets for each age category
vax_flu_byage <- ggplot(data = age_group_vax_vs_flu_severity, aes(x = pct_vaccinated, y = severe_new_rate, color = pct_vaccinated, text = paste("<b>County: </b>", county, "<br><b>Mean % Vaccinated for COVID: </b>", round(pct_vaccinated, 3)*100,"%", "<br><b>Flu Severity Rate: </b>", round(severe_new_rate,2)))) +
  geom_point(size = 2) +
  labs(title = "Figure 2: High COVID vaccination % not significantly associated with
low severe flu rate",
       subtitle = "Scatter Plots by Age Categories, Q4-2022 - Q2-2023",
       x = "Mean % Vaccinated for COVID
(cum. fully vaccinated / population)",
       y = "Flu Severity Rate
(new severe cases / new diagnoses)",
       color = "Mean % Vaccinated 
for COVID") +
  geom_smooth(aes(x = pct_vaccinated, y = severe_new_rate), method = lm, color = "yellow", inherit.aes = FALSE) +
  scale_color_gradient(low = "blue", high = "red") +  
  facet_wrap(~age_category, scales = "free") +  
  theme_minimal() + 
  theme(panel.margin.y = unit(2, "lines"))

# vax_flu_byage
# interactive
ggplotly(vax_flu_byage, tooltip = "text") %>%
  layout(
    title = list(text = paste0('Figure 2: High COVID vaccination % not significantly associated with
low severe flu rate','<br>','<sup>','Scatter Plots by Age Categories, Q4-2022 - Q2-2023','</sup>'), yref = 'container', xref = 'paper', yref = 'paper'),
    margin = list(t = 120, b = 60, l = 100, r = 30)
  )

# Rename df
age_group_vax_vs_flu_severity_table <- age_group_vax_vs_flu_severity

# Create a summary table
summary_table <- age_group_vax_vs_flu_severity_table %>%
  group_by(age_category) %>%
  summarize(mean_pct_vaccinated = mean(pct_vaccinated),
            mean_flu_severity = mean(severe_new_rate),
            correlation = round(cor(pct_vaccinated, severe_new_rate), 2)) %>%
  ungroup()

# Rename summary table data
colnames(summary_table ) <- c("Age Category", "Mean % Vaccinated for COVID", "Mean Severe Flu Rate", "Correlation")

# Print the table using kableExtra (Quality table #1)
kable(
  summary_table, 
  "html",
  caption = "<b><size=16>Table 2: High COVID vaccination % not significantly correlated with low severe flu rate within age categories, Q4-2022 - Q2-2023</size></b>") %>%
  kable_styling(full_width = FALSE)

```

## [Discussion]{.underline}

Our investigation of the relationship between COVID vaccination and severe flu morbidity across different age categories in California reveals intriguing insights.

However, it's crucial to recognize that this analysis pertains to aggregate-level data, and caution should be exercised in generalizing these findings to individual-level dynamics to avoid the ecological fallacy.

As seen in **Figure 1**, analysis of the COVID vaccination rate data and simulated flu data indicates that COVID vaccination does not seem to strongly reflect flu vaccination within the 57 California counties from which data was collected/simulated. Additional measures to promote flu vaccination may be needed.

Contrary to the implication that high COVID-19 vaccination counties would have low severe flu rates, the data in **Table 1** show no such trends: no correlation exists between the mean percentage of COVID-19 vaccination and the severity of flu cases in the studied counties.

As seen in **Table 2** and **Figure 2**, the age-stratified analysis examining the mean percentage of COVID vaccination alongside mean severe flu rates across distinct age categories highlights that while higher COVID vaccination rates are observed in older age groups, the mean severe flu rates do not consistently decrease with increasing vaccination rates. The 65+ age category, characterized by the highest COVID vaccination rate, exhibits a higher mean severe rate than anticipated.
