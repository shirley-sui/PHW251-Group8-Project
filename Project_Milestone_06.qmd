---
title: "Final Project: Exploring the Relationship Between COVID Vaccination and Flu Rates in 57 California Counties, from Q4-2022 to Q2-2023"
author: "Ngan Nguyen, Nicole Fernandez, Shirley Sui"
format: html
editor: visual
---

```{r load & set up, include=FALSE, echo=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)

# Load tidyverse for all data cleaning packages
library(tidyverse)
library(kableExtra)
library(ggplot2)
library(plotly)

#Load data from project Milestone #3 in Milestone_3_Clean_Data
df_vax <- read_csv('./Milestone_3_Clean_Data/df_ca_vax_clean_subset.csv')
df_flu <- read_csv('./Milestone_3_Clean_Data/df_flu_clean_aggregate.csv')

# Join all datasets together
# Flu data only has quarters 2022.4 to 2023.2
# Vax data has quarters 2022.1 to 2023.3
# Before joining, filter vax data to only 2022.4 to 2023.2

df_vax <- df_vax %>%
  filter(quarter >= 2022.4 & quarter <= 2023.2)

# perform inner_join - we don't want any data that doesn't have a match in both datasets
# also rename mean_vaccination_rate to pct_vaccinated

df_joined <- inner_join(df_flu, df_vax, by = join_by(age_category, county, quarter)) %>% select(!c(sum_dx_new, sum_severe_new)) %>% rename(pct_vaccinated = mean_vaccination_rate) %>% drop_na()
```

## [Problem Statement]{.underline}

Background & research question(s)/null & alternative hypotheses here:

-   Identify if COVID vaccination rates reflect flu vaccination rates in populations and or if more should be done to encourage flu vaccinations.
-   Identify where there is any correlation between COVID vaccination rates on flu rates and/or severity.
-   Does COVID vaccination affect flu severity within each age group?

## [Methods]{.underline}

-   Description of datasets (data source), years and/or dates of data
-   Description of cleaning, creating new variables (data manipulation)
-   Analytic methods

## [Results]{.underline}


```{r covid vax vs flu rate - Shirley, warning = FALSE, message = FALSE, echo = FALSE}
# COVID vaccination vs flu rate (new cases), per quarter, color coded by county

# Re-format facet labels for quarters
qtr.labs <- c("Q4-2022", "Q1-2023", "Q2-2023")
names(qtr.labs) <- c(2022.4, 2023.1, 2023.2)

vax_flu_byqtr <- df_joined %>%
  group_by(county, quarter) %>%
  mutate(mean_pct_vaccinated = mean(pct_vaccinated), dx_new_rate = mean(dx_new_rate)) %>%
  ggplot(aes(x = pct_vaccinated, y = dx_new_rate, color=county, text = paste("<b>County: </b>", county, "<br><b>Mean % Vaccinated for COVID: </b>", round(pct_vaccinated, 3)*100,"%", "<br><b>Mean Flu Rate: </b>", round(dx_new_rate,2)))) +
  geom_point() +
  geom_smooth(aes(x = pct_vaccinated, y = dx_new_rate), method = lm, color = "red", inherit.aes = FALSE) +
  theme_minimal() +
  scale_y_continuous(labels= function(x) round(x*100, digits = 2)) + 
  labs(x = "Mean % Vaccinated for COVID 
  (cum. fully vaccinated / population) ", y = "Mean Flu Rate 
  (new diagnoses / 100 susceptible)", title = "Figure 1: COVID vaccination does not imply flu vaccination", subtitle = "based on quarterly cumulative COVID vaccination data compared to simulated flu incidence rate data per 
quarter across 57 California counties, from Q4-2022 to Q2-2023") +
  facet_wrap(~quarter, scales = "free", labeller = labeller(quarter = qtr.labs)) + 
  theme(
    legend.position = "none", 
    plot.title.position = "plot",
    plot.title = element_text(face = "bold"), 
    plot.subtitle = element_text(face = "italic"), 
    strip.text.x = element_text(face = "bold"),
    axis.title.y = element_text(margin = margin(r = 5)),
    axis.title.x = element_text(margin = margin(t = 5)))

ggplotly(vax_flu_byqtr, tooltip = "text") %>%
  layout(
    title = list(text = paste0('Figure 1: COVID vaccination does not imply flu vaccination','<br>','<sup>','Across 57 California counties, from Q4-2022 to Q2-2023','</sup>'), yref = 'container', xref = 'paper', yref = 'paper'), 
    annotations = list(text = paste0('<sup>','Based on quarterly cumulative COVID vaccination data compared to simulated flu incidence rate data per quarter','</sup>'), showarrow = F, xref = 'paper', yref = 'paper', xanchor = 'right', yanchor = 'auto', xshift = 350, yshift = -200),
    margin = list(t = 150, b = 110, l = 100, r = 30)
  )
```

```{r Correlation table indicating relationship between COVID vaccination and severe flu rate - Kim, warning = FALSE, message = FALSE, echo = FALSE}

# Redone - misread research question #2 in previous milestone

# Calculate the correlation for each county
correlation_table <- df_joined %>%
  group_by(county) %>%
  summarise(
    mean_pct_vaccinated_county = mean(pct_vaccinated),
    mean_severe_new_rate = mean(severe_new_rate),
    Correlation = round(cor(pct_vaccinated, severe_new_rate), 2)
  ) %>% 
  ungroup() %>%
  distinct(county, .keep_all = TRUE)

# Rename columns
colnames(correlation_table) <- c("County", "Mean % Vaccinated for COVID", "Mean Severe Flu Rate", "Correlation")

# Print the correlation table with kableExtra
  kable(
    correlation_table,
    format = "html", 
    caption = "Table 1: No clear correlation between COVID vaccination and mean severe flu rate within each county, Q4-2022 - Q2-2023") %>% 
  kable_styling(full_width = FALSE) 


```

```{r age group vax vs flu severity -Nicole, warning = FALSE, message = FALSE, echo = FALSE}
# Visualization: One print quality plot or chart as requested in scenario
# Using Both a table & a chart seem appropriate for this specific research question
# Rename joined df
age_group_vax_vs_flu_severity <- df_joined

# Rename df
age_group_vax_vs_flu_severity_table <- age_group_vax_vs_flu_severity

# Create a summary table
summary_table <- age_group_vax_vs_flu_severity_table %>%
  group_by(age_category) %>%
  summarize(mean_pct_vaccinated = mean(pct_vaccinated),
            mean_flu_severity = mean(severe_new_rate),
            correlation = round(cor(pct_vaccinated, severe_new_rate), 2)) %>%
  ungroup()

# Rename summary table data
colnames(summary_table ) <- c("Age Category", "Mean % Vaccinated for COVID", "Mean Severe Flu Rate", "Correlation")

# Print the table using kableExtra (Quality table #1)
kable(
  summary_table, 
  "html",
  caption = "Table 2: High COVID vaccination % not significantly correlated with low severe flu rate within age categories, Q4-2022 - Q2-2023") %>%
  kable_styling(full_width = FALSE)


# Quality plot

# Scatter plot with facets for each age category
vax_flu_byage <- ggplot(data = age_group_vax_vs_flu_severity, aes(x = pct_vaccinated, y = severe_new_rate, color = pct_vaccinated, text = paste("<b>County: </b>", county, "<br><b>Mean % Vaccinated for COVID: </b>", round(pct_vaccinated, 3)*100,"%", "<br><b>Flu Severity Rate: </b>", round(severe_new_rate,2)))) +
  geom_point(size = 2) +
  labs(title = "Figure 2: High COVID vaccination % not significantly associated with
low severe flu rate",
       subtitle = "Scatter Plots by Age Categories, Q4-2022 - Q2-2023",
       x = "Mean % Vaccinated for COVID
(cum. fully vaccinated / population)",
       y = "Flu Severity Rate
(new severe cases / new diagnoses)",
       color = "Mean % Vaccinated 
for COVID") +
  geom_smooth(aes(x = pct_vaccinated, y = severe_new_rate), method = lm, color = "yellow", inherit.aes = FALSE) +
  scale_color_gradient(low = "blue", high = "red") +  
  facet_wrap(~age_category, scales = "free") +  
  theme_minimal() + 
  theme(panel.margin.y = unit(2, "lines"))

# vax_flu_byage
# interactive
ggplotly(vax_flu_byage, tooltip = "text") %>%
  layout(
    title = list(text = paste0('Figure 2: High COVID vaccination % not significantly associated with
low severe flu rate','<br>','<sup>','Scatter Plots by Age Categories, Q4-2022 - Q2-2023','</sup>'), yref = 'container', xref = 'paper', yref = 'paper'),
    margin = list(t = 120, b = 60, l = 100, r = 30)
  )

```

## [Discussion]{.underline}

** NOTE: I just pasted all of our interpretations here - it should be modified to flow better and maybe provide more context. Some of this might belong more in the Results section, too**

It's crucial to recognize that this analysis pertains to aggregate-level data, and caution should be exercised in generalizing these findings to individual-level dynamics to avoid the ecological fallacy.

Analysis of the COVID vaccination rate data and simulated flu data indicates that COVID vaccination does not seem to strongly reflect flu vaccination within the 57 California counties from which data was collected/simulated. Additional measures to promote flu vaccination may be needed.

Correlation values per each case provide insights into the relationships between COVID vaccination rates and severe flu cases rates in different scenarios, ranging from weak negative to moderate positive correlations. There is a significant weak negative correlation between the high vaccination rate group and low severe flu rate which might be impacted by confounders.

COVID vaccination versus flu severity by age group interpretation: The data indicates an age-related uptrend in vaccination rates among the older demographics. Intriguingly, despite heightened vaccination coverage in these age groups, there is a simultaneous upswing in average flu severity.
